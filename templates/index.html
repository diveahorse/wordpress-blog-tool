{% extends "base.html" %}

{% block title %}ホーム - WordPressブログ管理ツール{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-magic me-3"></i>ブログ記事生成ツール
            </h1>
            <p class="lead text-muted">
                AIを活用して高品質なブログ記事を自動生成し、WordPressに直接投稿できます
            </p>
        </div>

        <!-- Connection Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plug me-2"></i>接続テスト
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Perplexity APIとWordPressの接続状態を確認します。
                </p>
                <button id="testConnections" class="btn btn-outline-primary">
                    <i class="fas fa-check me-1"></i>接続テスト実行
                </button>
                <div id="connectionResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Article Generation Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>記事生成フォーム
                </h5>
            </div>
            <div class="card-body">
                <form id="articleForm">
                    <!-- Theme Input -->
                    <div class="mb-3">
                        <label for="theme" class="form-label">
                            <i class="fas fa-lightbulb me-1"></i>記事のテーマ *
                        </label>
                        <input type="text" class="form-control" id="theme" name="theme" 
                               placeholder="例: 健康な食事の作り方、効率的な時間管理術、AI技術の最新動向" required>
                        <div class="form-text">
                            記事のテーマやトピックを具体的に入力してください。
                        </div>
                    </div>

                    <!-- Prompt Template Selection -->
                    <div class="mb-3">
                        <label for="promptType" class="form-label">
                            <i class="fas fa-file-alt me-1"></i>プロンプトテンプレート
                        </label>
                        <select class="form-select" id="promptType" name="promptType">
                            {% for key, template in prompt_templates.items() %}
                            <option value="{{ key }}" data-description="{{ template.description }}">
                                {{ template.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="templateDescription" class="form-text">
                            {{ prompt_templates.default.description }}
                        </div>
                    </div>

                    <!-- Post Status -->
                    <div class="mb-3">
                        <label for="status" class="form-label">
                            <i class="fas fa-eye me-1"></i>投稿ステータス
                        </label>
                        <select class="form-select" id="status" name="status">
                            <option value="draft">下書き</option>
                            <option value="publish">公開</option>
                        </select>
                        <div class="form-text">
                            下書きとして保存するか、すぐに公開するかを選択してください。
                        </div>
                    </div>

                    <!-- Max Tokens -->
                    <div class="mb-3">
                        <label for="maxTokens" class="form-label">
                            <i class="fas fa-text-width me-1"></i>最大トークン数
                        </label>
                        <select class="form-select" id="maxTokens" name="maxTokens">
                            <option value="2048">2,048 (短めの記事)</option>
                            <option value="4096" selected>4,096 (標準)</option>
                            <option value="8192">8,192 (長めの記事)</option>
                        </select>
                        <div class="form-text">
                            生成する記事の長さを調整できます。トークン数が多いほど詳細な記事になります。
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                            <i class="fas fa-magic me-2"></i>記事を生成して投稿
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>生成中...
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <p id="currentStep" class="text-muted mb-0">初期化中...</p>
            </div>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle text-success me-2"></i>生成完了
                </h5>
            </div>
            <div class="card-body">
                <div id="resultContent"></div>
            </div>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="card mt-4" style="display: none;">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>エラー
                </h5>
            </div>
            <div class="card-body">
                <div id="errorContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('articleForm');
    const promptType = document.getElementById('promptType');
    const templateDescription = document.getElementById('templateDescription');
    const testConnectionsBtn = document.getElementById('testConnections');
    const connectionResult = document.getElementById('connectionResult');
    const progressSection = document.getElementById('progressSection');
    const resultSection = document.getElementById('resultSection');
    const errorSection = document.getElementById('errorSection');
    const progressBar = document.getElementById('progressBar');
    const currentStep = document.getElementById('currentStep');
    const resultContent = document.getElementById('resultContent');
    const errorContent = document.getElementById('errorContent');
    const generateBtn = document.getElementById('generateBtn');

    // プロンプトテンプレートの説明を更新
    promptType.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        templateDescription.textContent = description;
    });

    // 接続テスト
    testConnectionsBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>テスト中...';
        connectionResult.innerHTML = '';

        fetch('/test-connections')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    connectionResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i>${data.error}
                        </div>
                    `;
                } else {
                    connectionResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i>${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                connectionResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i>接続テストでエラーが発生しました: ${error}
                    </div>
                `;
            })
            .finally(() => {
                testConnectionsBtn.disabled = false;
                testConnectionsBtn.innerHTML = '<i class="fas fa-check me-1"></i>接続テスト実行';
            });
    });

    // 記事生成フォーム送信
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            theme: document.getElementById('theme').value,
            prompt_type: document.getElementById('promptType').value,
            status: document.getElementById('status').value,
            max_tokens: parseInt(document.getElementById('maxTokens').value)
        };

        // UI状態を更新
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>生成中...';
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';
        errorSection.style.display = 'none';

        // 記事生成を開始
        fetch('/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                // 進捗監視を開始
                monitorProgress();
            }
        })
        .catch(error => {
            showError('記事生成でエラーが発生しました: ' + error);
        });
    });

    function monitorProgress() {
        const interval = setInterval(() => {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // 進捗バーを更新
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress + '%';
                    currentStep.textContent = data.current_step;

                    if (!data.is_generating) {
                        clearInterval(interval);
                        
                        if (data.error) {
                            showError(data.error);
                        } else if (data.result) {
                            showResult(data.result);
                        }
                        
                        // UI状態をリセット
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>記事を生成して投稿';
                        progressSection.style.display = 'none';
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    showError('進捗の取得でエラーが発生しました: ' + error);
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>記事を生成して投稿';
                    progressSection.style.display = 'none';
                });
        }, 1000);
    }

    function showResult(result) {
        resultContent.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-1"></i>記事の生成と投稿が完了しました！</h6>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-heading me-1"></i>タイトル</h6>
                    <p class="text-muted">${result.title}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-tag me-1"></i>ステータス</h6>
                    <span class="badge bg-${result.status === 'publish' ? 'success' : 'warning'}">
                        ${result.status === 'publish' ? '公開' : '下書き'}
                    </span>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-link me-1"></i>投稿URL</h6>
                    <a href="${result.post_url}" target="_blank" class="text-decoration-none">
                        <i class="fas fa-external-link-alt me-1"></i>記事を確認
                    </a>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-id-card me-1"></i>投稿ID</h6>
                    <p class="text-muted">${result.post_id}</p>
                </div>
            </div>
        `;
        resultSection.style.display = 'block';
    }

    function showError(error) {
        errorContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-1"></i>${error}
            </div>
        `;
        errorSection.style.display = 'block';
    }
});
</script>
{% endblock %}
