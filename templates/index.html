{% extends "base.html" %}

{% block title %}ホーム - WordPressブログ管理ツール{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-magic me-3"></i>ブログ記事生成ツール
            </h1>
            <p class="lead text-muted">
                AIを活用して高品質なブログ記事を自動生成し、WordPressに直接投稿できます
            </p>
            <div class="mt-3">
                <a href="{{ url_for('generation_history') }}" class="btn btn-outline-primary">
                    <i class="fas fa-history me-1"></i>生成履歴を表示
                </a>
                <a href="{{ url_for('prompts') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-file-alt me-1"></i>プロンプト管理
                </a>
            </div>
        </div>

        <!-- Connection Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plug me-2"></i>接続テスト
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Perplexity APIとWordPressの接続状態を確認します。
                </p>
                <button id="testConnections" class="btn btn-outline-primary">
                    <i class="fas fa-check me-1"></i>接続テスト実行
                </button>
                <div id="connectionResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Article Generation Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>記事生成フォーム
                </h5>
            </div>
            <div class="card-body">
                <form id="articleForm">
                    <!-- Theme Input -->
                    <div class="mb-3">
                        <label for="theme" class="form-label">
                            <i class="fas fa-lightbulb me-1"></i>記事のテーマ *
                        </label>
                        <input type="text" class="form-control" id="theme" name="theme" 
                               placeholder="例: 健康な食事の作り方、効率的な時間管理術、AI技術の最新動向、感動するアニメランキング" required>
                        <div class="form-text">
                            記事のテーマやトピックを具体的に入力してください。アニメランキングの場合は自動で画像が添付されます。
                        </div>
                    </div>

                    <!-- Prompt Template Selection -->
                    <div class="mb-3">
                        <label for="promptType" class="form-label">
                            <i class="fas fa-file-alt me-1"></i>プロンプトテンプレート
                        </label>
                        <select class="form-select" id="promptType" name="promptType">
                            {% for key, template in prompt_templates.items() %}
                            <option value="{{ key }}" data-description="{{ template.description }}">
                                {{ template.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="templateDescription" class="form-text">
                            {{ prompt_templates.default.description }}
                        </div>
                    </div>

                    <!-- Post Status -->
                    <div class="mb-3">
                        <label for="status" class="form-label">
                            <i class="fas fa-eye me-1"></i>投稿ステータス
                        </label>
                        <select class="form-select" id="status" name="status">
                            <option value="draft">下書き</option>
                            <option value="publish">公開</option>
                        </select>
                        <div class="form-text">
                            下書きとして保存するか、すぐに公開するかを選択してください。
                        </div>
                    </div>

                    <!-- Max Tokens -->
                    <div class="mb-3">
                        <label for="maxTokens" class="form-label">
                            <i class="fas fa-text-width me-1"></i>最大トークン数
                        </label>
                        <select class="form-select" id="maxTokens" name="maxTokens">
                            <option value="2048">2,048 (短めの記事)</option>
                            <option value="4096" selected>4,096 (標準)</option>
                            <option value="8192">8,192 (長めの記事)</option>
                        </select>
                        <div class="form-text">
                            生成する記事の長さを調整できます。トークン数が多いほど詳細な記事になります。
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                            <i class="fas fa-magic me-2"></i>記事を生成して投稿
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>生成中...
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p id="currentStep" class="text-muted mb-0">初期化中...</p>
                
                <!-- 画像添付進捗 -->
                <div id="imageProgress" class="mt-3" style="display: none;">
                    <h6><i class="fas fa-image me-1"></i>画像添付状況</h6>
                    <div id="imageStatus" class="small text-muted"></div>
                    <div id="imageProgressBar" class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar progress-bar-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 詳細な進捗情報 -->
                <div id="detailedProgress" class="mt-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">処理時間</small>
                            <div id="elapsedTime">00:00</div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">推定残り時間</small>
                            <div id="estimatedTime">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle text-success me-2"></i>生成完了
                </h5>
            </div>
            <div class="card-body">
                <div id="resultContent"></div>
            </div>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="card mt-4" style="display: none;">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>エラー
                </h5>
            </div>
            <div class="card-body">
                <div id="errorContent"></div>
                <div class="mt-3">
                    <button class="btn btn-outline-danger" onclick="retryGeneration()">
                        <i class="fas fa-redo me-1"></i>再試行
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('articleForm');
    const promptType = document.getElementById('promptType');
    const templateDescription = document.getElementById('templateDescription');
    const testConnectionsBtn = document.getElementById('testConnections');
    const connectionResult = document.getElementById('connectionResult');
    const progressSection = document.getElementById('progressSection');
    const resultSection = document.getElementById('resultSection');
    const errorSection = document.getElementById('errorSection');
    const progressBar = document.getElementById('progressBar');
    const currentStep = document.getElementById('currentStep');
    const resultContent = document.getElementById('resultContent');
    const errorContent = document.getElementById('errorContent');
    const generateBtn = document.getElementById('generateBtn');
    const imageProgress = document.getElementById('imageProgress');
    const imageStatus = document.getElementById('imageStatus');
    const imageProgressBar = document.getElementById('imageProgressBar');
    const detailedProgress = document.getElementById('detailedProgress');
    const elapsedTime = document.getElementById('elapsedTime');
    const estimatedTime = document.getElementById('estimatedTime');

    let startTime = null;
    let progressInterval = null;

    // プロンプトテンプレートの説明を更新
    promptType.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        templateDescription.textContent = description;
        
        // アニメランキングテンプレートが選択された場合の説明
        if (this.value.includes('ランキング')) {
            templateDescription.innerHTML = description + ' <span class="badge bg-info">画像自動添付対応</span>';
        }
    });

    // 接続テスト
    testConnectionsBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>テスト中...';
        connectionResult.innerHTML = '';

        fetch('/test-connections')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    connectionResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i>${data.error}
                        </div>
                    `;
                } else {
                    connectionResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i>${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                connectionResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i>接続テストでエラーが発生しました: ${error}
                    </div>
                `;
            })
            .finally(() => {
                testConnectionsBtn.disabled = false;
                testConnectionsBtn.innerHTML = '<i class="fas fa-check me-1"></i>接続テスト実行';
            });
    });

    // 記事生成フォーム送信
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            theme: document.getElementById('theme').value,
            prompt_type: document.getElementById('promptType').value,
            status: document.getElementById('status').value,
            max_tokens: parseInt(document.getElementById('maxTokens').value)
        };

        // UI状態を更新
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>生成中...';
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';
        errorSection.style.display = 'none';
        
        // 進捗追跡を開始
        startTime = new Date();
        startProgressTracking();

        // 記事生成を開始
        fetch('/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                // 進捗監視を開始
                monitorProgress();
            }
        })
        .catch(error => {
            showError('記事生成でエラーが発生しました: ' + error);
        });
    });

    function startProgressTracking() {
        progressInterval = setInterval(() => {
            if (startTime) {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                elapsedTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }

    function stopProgressTracking() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    function monitorProgress() {
        const interval = setInterval(() => {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // 進捗バーを更新
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress);
                    currentStep.textContent = data.current_step;

                    // 画像添付状況を表示
                    if (data.current_step && data.current_step.includes('画像')) {
                        imageProgress.style.display = 'block';
                        imageStatus.textContent = data.current_step;
                        
                        // 画像進捗バーを更新（推定）
                        const imageProgressPercent = Math.min(data.progress - 70, 20);
                        const imageProgressBarInner = imageProgressBar.querySelector('.progress-bar');
                        imageProgressBarInner.style.width = imageProgressPercent + '%';
                    }

                    // 詳細進捗を表示
                    if (data.progress > 10) {
                        detailedProgress.style.display = 'block';
                    }

                    if (!data.is_generating) {
                        clearInterval(interval);
                        stopProgressTracking();
                        
                        if (data.error) {
                            showError(data.error);
                        } else if (data.result) {
                            showResult(data.result);
                        }
                        
                        // UI状態をリセット
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>記事を生成して投稿';
                        progressSection.style.display = 'none';
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    stopProgressTracking();
                    showError('進捗の取得でエラーが発生しました: ' + error);
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>記事を生成して投稿';
                    progressSection.style.display = 'none';
                });
        }, 1000);
    }

    function showResult(result) {
        const statusBadge = result.status === 'publish' ? 
            '<span class="badge bg-success">公開</span>' : 
            '<span class="badge bg-warning">下書き</span>';
        
        resultContent.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-1"></i>記事の生成と投稿が完了しました！</h6>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-heading me-1"></i>タイトル</h6>
                    <p class="text-muted">${result.title}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-tag me-1"></i>ステータス</h6>
                    ${statusBadge}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-link me-1"></i>投稿URL</h6>
                    <a href="${result.post_url}" target="_blank" class="text-decoration-none">
                        <i class="fas fa-external-link-alt me-1"></i>記事を確認
                    </a>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-id-card me-1"></i>投稿ID</h6>
                    <p class="text-muted">${result.post_id}</p>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-outline-primary" onclick="window.open('${result.post_url}', '_blank')">
                    <i class="fas fa-external-link-alt me-1"></i>記事を開く
                </button>
                <button class="btn btn-outline-secondary" onclick="copyToClipboard('${result.post_url}')">
                    <i class="fas fa-copy me-1"></i>URLをコピー
                </button>
            </div>
        `;
        resultSection.style.display = 'block';
    }

    function showError(error) {
        errorContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-1"></i>${error}
            </div>
        `;
        errorSection.style.display = 'block';
    }

    // 再試行機能
    window.retryGeneration = function() {
        errorSection.style.display = 'none';
        form.dispatchEvent(new Event('submit'));
    };

    // URLコピー機能
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            // コピー成功のフィードバック
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-1"></i>コピー完了';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        });
    };
});
</script>
{% endblock %}
